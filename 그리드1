
Vue2 (ag-Grid) â€“ MxTrendGrid.vue
ì½”ë“œ ë³µì‚¬
Vue
<template>
  <div class="mx-trend-wrap">
    <div class="toolbar">
      <label>Departments</label>
      <input v-model="departmentsCsv" placeholder="ì˜ˆ: ASSY,PACK" />
      <label>Start</label>
      <input v-model="startDate" type="date" />
      <label>End</label>
      <input v-model="endDate" type="date" />
      <button @click="fetchTrend">ì¡°íšŒ</button>
    </div>

    <ag-grid-vue
      class="ag-theme-alpine"
      style="width: 100%; height: 560px"
      :columnDefs="columnDefs"
      :defaultColDef="defaultColDef"
      :rowData="rowData"
      :animateRows="true"
      :suppressDragLeaveHidesColumns="true"
      :rowClassRules="rowClassRules"
    />
  </div>
</template>

<script>
import axios from 'axios';
import { AgGridVue } from 'ag-grid-vue';

export default {
  name: 'MxTrendGrid',
  components: { AgGridVue },
  data() {
    return {
      departments: ['depart'],
      startDate: '2025-01-01',
      endDate: '2025-01-31',
      rowData: [],
      columnDefs: [],
      defaultColDef: {
        resizable: true,
        sortable: true,
        filter: 'agTextColumnFilter',
        valueFormatter: (p) => {
          const v = p.value;
          if (v === null || v === undefined || Number.isNaN(v)) return '';
          if (typeof v === 'number') return v.toFixed(4);
          return v;
        }
      },
      rowClassRules: {
        'row-sum':        p => p.data?.action_name === 'sum',
        'row-daily':      p => p.data?.action_name === 'Daily_MAction ìˆ˜',
        'row-mx-day-min': p => p.data?.action_name === 'MX/day(min)'
      }
    };
  },
  computed: {
    departmentsCsv: {
      get() { return this.departments.join(','); },
      set(v) { this.departments = v.split(',').map(s => s.trim()).filter(Boolean); }
    }
  },
  mounted() { this.fetchTrend(); },
  methods: {
    async fetchTrend() {
      const params = new URLSearchParams();
      this.departments.forEach(d => params.append('departments', d));
      params.append('start', this.startDate);
      params.append('end', this.endDate);

      const { data } = await axios.get('/api/mx/trend', { params });
      this.rowData = Array.isArray(data) ? data : [];

      const fixed = new Set(['action_name', 'component', 'í•­ëª©ë³„ ALL', 'day(sec)', 'day(min)']);
      const eqpKeys = this.collectEqpKeys(this.rowData, fixed);

      this.columnDefs = [
        { headerName: 'MACTION',   field: 'action_name', pinned: 'left', minWidth: 140 },
        { headerName: 'COMPONENT', field: 'component',   pinned: 'left', minWidth: 120 },
        ...eqpKeys.map(k => ({
          headerName: k.toUpperCase(),
          field: k,
          type: 'rightAligned',
          cellClass: p => (typeof p.value === 'number' ? 'ag-right-aligned-cell' : '')
        })),
        { headerName: 'í•­ëª©ë³„ ALL', field: 'í•­ëª©ë³„ ALL', type: 'rightAligned', minWidth: 120 },
        { headerName: 'day(sec)',  field: 'day(sec)',    type: 'rightAligned', minWidth: 110 },
        { headerName: 'day(min)',  field: 'day(min)',    type: 'rightAligned', minWidth: 110 }
      ];
    },
    collectEqpKeys(rows, fixed) {
      const set = new Set();
      rows.forEach(r => Object.keys(r || {}).forEach(k => {
        if (!fixed.has(k) && k.toLowerCase().startsWith('eqp')) set.add(k);
      }));
      return Array.from(set).sort((a, b) => {
        const na = parseInt(a.replace(/^\D+/g, ''), 10);
        const nb = parseInt(b.replace(/^\D+/g, ''), 10);
        if (Number.isNaN(na) || Number.isNaN(nb)) return a.localeCompare(b);
        return na - nb;
      });
    }
  }
};
</script>

<style scoped>
.mx-trend-wrap { width: 100%; }
.toolbar { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
.toolbar input { width: 160px; }
.row-sum        { background: rgba(0,0,0,0.03); font-weight: 600; }
.row-daily      { background: rgba(0,128,255,0.06); }
.row-mx-day-min { background: rgba(255,165,0,0.10); }
</style>
Spring Boot
1) DTO â€“ MxHistoryRow.java
ì½”ë“œ ë³µì‚¬
Java
package com.example.mx.domain;

import lombok.Getter;
import lombok.Setter;

/** MX ì´ë ¥ ë‹¨ì¼ í–‰ (DB numeric â†’ Java double) */
@Getter
@Setter
public class MxHistoryRow {
    private String eqpId;
    private String actionName;
    private String component;
    private double mxSeconds; // numeric
}
2) Mapper ì‹œê·¸ë‹ˆì²˜ â€“ MxMapper.java  (êµ¬í˜„/XML ìƒëµ)
ì½”ë“œ ë³µì‚¬
Java
package com.example.mx.application;

import com.example.mx.domain.MxHistoryRow;
import java.util.List;

/**
 * ë¶€ì„œë“¤ + ê¸°ê°„(ë¬¸ìì—´)ë¡œ MX ì´ë ¥ì„ í•œ ë²ˆì— ë¡œë“œ
 * - ì¢…ë£Œì¼ í¬í•¨(+1day)ì€ SQLì—ì„œ ì²˜ë¦¬ ê¶Œì¥
 * - ì •ë ¬: line, eqpId, summaryDate, mxTime (action_nameì€ ì •ë ¬ ì•ˆ í•¨)
 */
public interface MxMapper {
    List<MxHistoryRow> loadAllMxHistoryByDepartments(
            List<String> departments,
            String startDate,  // "yyyy-MM-dd"
            String endDate     // "yyyy-MM-dd"
    );
}
3) Service â€“ MxTrendService.java
ì½”ë“œ ë³µì‚¬
Java
package com.example.mx.application;

import java.util.List;
import java.util.Map;

/** ë°˜í™˜ ì»¬ëŸ¼: action_name, component, eqp..., í•­ëª©ë³„ ALL, day(sec), day(min) */
public interface MxTrendService {
    List<Map<String, Object>> buildTrend(List<String> departments, String startDate, String endDate);
}


4) ServiceImpl â€“ MxTrendServiceImpl.java  (DB ì •ë ¬ ì¡´ì¤‘, ì¤‘ë³µ ì œê±°ë§Œ)
ì½”ë“œ ë³µì‚¬
Java




package com.example.mx.application;

import com.example.mx.domain.MxHistoryRow;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.stream.Collectors;

@Service
public class MxTrendServiceImpl implements MxTrendService {

    private final MxMapper mxMapper;

    public MxTrendServiceImpl(MxMapper mxMapper) {
        this.mxMapper = mxMapper;
    }

    @Override
    public List<Map<String, Object>> buildTrend(List<String> departments, String startDate, String endDate) {
        if (departments == null || departments.isEmpty()) return Collections.emptyList();

        final List<MxHistoryRow> mxHistories =
                mxMapper.getAllMxHistoryByDepartments(departments, startDate, endDate);
        if (mxHistories == null || mxHistories.isEmpty()) return Collections.emptyList();

        // EQP ì»¬ëŸ¼ ëª©ë¡: DB ë“±ì¥ ìˆœì„œ ìœ ì§€ + ì¤‘ë³µ ì œê±°
        final List<String> eqpIds = mxHistories.stream()
                .map(MxHistoryRow::getEqpId)
                .filter(Objects::nonNull)
                .distinct()
                .collect(Collectors.toList());

        // í”¼ë²— êµ¬ì¡° ë§Œë“¤ê¸° (actionName+component ì¡°í•©ë³„ ì„¤ë¹„ë³„ mxSeconds í•©ê³„ ê³„ì‚°)
        final Map<String, Map<String, Double>> pivot = new LinkedHashMap<>();
        for (MxHistoryRow historyRow : mxHistories) {
            final String actionName = historyRow.getActionName();
            final String component = historyRow.getComponent() == null ? "" : historyRow.getComponent();
            final String pivotKey = actionName + "|" + component;

            Map<String, Double> equipmentSums = pivot.computeIfAbsent(pivotKey, key -> new LinkedHashMap<>());
            equipmentSums.merge(historyRow.getEqpId(), historyRow.getMxSeconds(), Double::sum);
        }

        // í”¼ë²—ì„ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë³€í™˜
        final List<Map<String, Object>> table = new ArrayList<>();
        for (Map.Entry<String, Map<String, Double>> pivotEntry : pivot.entrySet()) {
            final String pivotKey = pivotEntry.getKey();
            final int separatorIndex = pivotKey.indexOf('|');
            final String actionName = separatorIndex >= 0 ? pivotKey.substring(0, separatorIndex) : pivotKey;
            final String component = separatorIndex >= 0 ? pivotKey.substring(separatorIndex + 1) : "";

            final Map<String, Double> equipmentSums = pivotEntry.getValue();

            Map<String, Object> rowMap = new LinkedHashMap<>();
            rowMap.put("ActionName", actionName);
            rowMap.put("component", component);
            for (String eqpId : eqpIds) {
                // ğŸ”¸ ë³€ê²½ëœ ì½”ë“œ: ê°’ì´ ì—†ì„ ë•Œ null ë°˜í™˜ (0.0 ëŒ€ì‹ )
                rowMap.put(eqpId, equipmentSums.containsKey(eqpId) ? equipmentSums.get(eqpId) : null);
            }
            table.add(rowMap);
        }

        // actionName ê¸°ì¤€ìœ¼ë¡œ ì¬ì •ë ¬
        table.sort(Comparator.comparing(
            row -> ((String) row.get("ActionName")).toLowerCase(),
            Comparator.nullsLast(String::compareTo)
        ));

        // ì„¤ë¹„ë³„ í•©ê³„í–‰(ì—´ ë°©í–¥ í•©ê³„): actionName = "sum"
        Map<String, Object> equipmentTotalsRow = new LinkedHashMap<>();
        equipmentTotalsRow.put("ActionName", "sum");
        equipmentTotalsRow.put("component", null);
        for (String eqpId : eqpIds) {
            double columnSum = table.stream()
                    .mapToDouble(row -> toDoubleOrZero(row.get(eqpId)))
                    .sum();
            equipmentTotalsRow.put(eqpId, columnSum); // ì›ê°’
        }
        table.add(equipmentTotalsRow);

        // ê° í–‰ì˜ í•©ê³„(í–‰ ë°©í–¥ í•©ê³„) â†’ rowSum
        for (Map<String, Object> row : table) {
            double rowSum = eqpIds.stream()
                    .mapToDouble(eqpId -> toDoubleOrZero(row.get(eqpId)))
                    .sum();
            row.put("rowSum", rowSum); // ì›ê°’
        }

        // Daily_MAction ìˆ˜(ì„¤ë¹„ë³„ count) í–‰: actionName = "dailyMActionCount"
        Map<String, Long> dailyCountByEqp = mxHistories.stream()
                .filter(historyRow -> "Daily_MAction".equals(historyRow.getActionName()))
                .collect(Collectors.groupingBy(
                        MxHistoryRow::getEqpId, LinkedHashMap::new, Collectors.counting()
                ));

        Map<String, Object> dailyCountRow = new LinkedHashMap<>();
        dailyCountRow.put("ActionName", "dailyMActionCount");
        dailyCountRow.put("component", null);
        long dailyTotalCount = 0L;
        for (String eqpId : eqpIds) {
            long count = dailyCountByEqp.getOrDefault(eqpId, 0L);
            dailyCountRow.put(eqpId, count); // ì •ìˆ˜ ìœ ì§€
            dailyTotalCount += count;
        }
        dailyCountRow.put("rowSum", dailyTotalCount); // ì •ìˆ˜ í•©
        dailyCountRow.put("daySec", null);
        dailyCountRow.put("dayMin", null);

        // daySec, dayMin ê³„ì‚° (ë¶„ëª¨ 0 ë³´í˜¸)
        double denominator = (dailyTotalCount == 0L) ? 1.0 : (double) dailyTotalCount;
        for (Map<String, Object> row : table) {
            double rowSum = ((Number) row.getOrDefault("rowSum", 0.0)).doubleValue();
            row.put("daySec", rowSum / denominator);
            row.put("dayMin", (rowSum / denominator) / 60.0);
        }

        // MX/day(min) í–‰: ì„¤ë¹„í•© / ì„¤ë¹„ë³„ daily count / 60
        Map<String, Object> mxPerDayMinRow = new LinkedHashMap<>();
        mxPerDayMinRow.put("ActionName", "mxPerDayMin");
        mxPerDayMinRow.put("component", null);
        double mxDayMinTotal = 0.0;
        for (String eqpId : eqpIds) {
            double equipmentSum = ((Number) equipmentTotalsRow.getOrDefault(eqpId, 0.0)).doubleValue();
            long dailyCount = ((Number) dailyCountRow.getOrDefault(eqpId, 0L)).longValue();
            double value = (dailyCount == 0L) ? 0.0 : (equipmentSum / dailyCount / 60.0);
            mxPerDayMinRow.put(eqpId, value); // ì›ê°’
            mxDayMinTotal += value;
        }
        mxPerDayMinRow.put("rowSum", mxDayMinTotal);
        mxPerDayMinRow.put("daySec", null);
        mxPerDayMinRow.put("dayMin", null);

        // ìµœì¢… ì¶œë ¥: eqp/rowSum/daySec/dayMin 4ìë¦¬ ë°˜ì˜¬ë¦¼ (countëŠ” ì •ìˆ˜ ìœ ì§€, nullì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
        List<Map<String, Object>> result = new ArrayList<>();
        for (Map<String, Object> row : table) result.add(roundRowForOutput(row, eqpIds));
        result.add(roundRowForOutput(dailyCountRow, eqpIds));
        result.add(roundRowForOutput(mxPerDayMinRow, eqpIds));

        return result;
    }

    // ===== Helpers =====

    private static double round4(double value) {
        return Math.round(value * 10000.0) / 10000.0;
    }

    private static Object roundForDisplay(Object value) {
        if (value == null) return null;
        if (value instanceof Integer || value instanceof Long) return value;
        if (value instanceof Number) return round4(((Number) value).doubleValue());
        return value;
    }

    // ê³µí†µ: null â†’ 0.0, Number â†’ double, ê·¸ ì™¸ â†’ 0.0
    private static double toDoubleOrZero(Object value) {
        return (value instanceof Number) ? ((Number) value).doubleValue() : 0.0;
    }

    /** ì¶œë ¥ìš© ë°˜ì˜¬ë¦¼: eqp/rowSum/daySec/dayMinì€ 4ìë¦¬ ë°˜ì˜¬ë¦¼, countëŠ” ì •ìˆ˜ ìœ ì§€, null ê·¸ëŒ€ë¡œ */
    private static Map<String, Object> roundRowForOutput(Map<String, Object> row, List<String> eqpIds) {
        Map<String, Object> outputRow = new LinkedHashMap<>();
        outputRow.put("ActionName", row.get("ActionName"));
        outputRow.put("component", row.get("component"));

        // EQPë³„ ê°’ ë°˜ì˜¬ë¦¼
        for (String eqpId : eqpIds) {
            outputRow.put(eqpId, roundForDisplay(row.get(eqpId)));
        }

        // ê³µí†µ ê·œì¹™ ì ìš©
        outputRow.put("rowSum", roundForDisplay(row.get("rowSum")));
        outputRow.put("daySec", roundForDisplay(row.get("daySec")));
        outputRow.put("dayMin", roundForDisplay(row.get("dayMin")));

        return outputRow;
    }
}



5) Controller â€“ MxTrendController.java
ì½”ë“œ ë³µì‚¬
Java
package com.example.mx.presentation;

import com.example.mx.application.MxTrendService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/** ë‚ ì§œëŠ” String("yyyy-MM-dd")ìœ¼ë¡œ ì£¼ê³ ë°›ìŠµë‹ˆë‹¤. */
@RestController
@RequestMapping("/api/mx")
public class MxTrendController {

    private final MxTrendService mxTrendService;

    public MxTrendController(MxTrendService mxTrendService) {
        this.mxTrendService = mxTrendService;
    }

    @GetMapping("/trend")
    public ResponseEntity<List<Map<String, Object>>> getTrend(
            @RequestParam("departments") List<String> departments,
            @RequestParam("start") String startDate,
            @RequestParam("end") String endDate
    ) {
        return ResponseEntity.ok(mxTrendService.buildTrend(departments, startDate, endDate));
    }
}
Controller í…ŒìŠ¤íŠ¸ (ì‹¬í”Œ í¬ë§·)
ì§€ìš°ë‹˜ í¬ë§· ê·¸ëŒ€ë¡œ ë§ì·„ìŠµë‹ˆë‹¤.
@StandaloneConfiguration + @EnableGlobalMethodSecurity(prePostEnabled = true)
@Beanìœ¼ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬/ì„œë¹„ìŠ¤ ìƒì„±, ë§¤í¼ëŠ” @MockBean
buildStandaloneMockMvc(controller), loginAsUser() í˜¸ì¶œ
perform(getRequest(...)) ì‚¬ìš©
í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ ë„¤ì´ë°: {ì»¨íŠ¸ë¡¤ëŸ¬í•¨ìˆ˜ëª…}_SHOULD_return_status_200_WHENEVER
ì½”ë“œ ë³µì‚¬
Java
package com.example.mx.presentation;

import com.example.mx.application.MxMapper;
import com.example.mx.application.MxTrendService;
import com.example.mx.application.MxTrendServiceImpl;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.mock.mockito.MockBean;

import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

/**
 * ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì—ì„œ ì œê³µí•œë‹¤ê³  ê°€ì •:
 * - buildStandaloneMockMvc(Object... controllers)
 * - loginAsUser()
 * - baseUrl, getRequest(String url)
 */
public class MxTrendControllerTest extends APIUnitExtension {

    @TestConfiguration
    @EnableGlobalMethodSecurity(prePostEnabled = true)
    public static class Config {
        @Bean
        public MxTrendController controller(MxTrendService service) {
            return new MxTrendController(service);
        }
        @Bean
        public MxTrendService service(MxMapper mapper) {
            return new MxTrendServiceImpl(mapper);
        }
    }

    @Autowired
    MxTrendController controller;

    @Autowired
    MxTrendService service;

    @MockBean
    MxMapper mapper;

    @BeforeEach
    void setUp() {
        buildStandaloneMockMvc(controller);
        loginAsUser();
    }

    @Test
    @DisplayName("GET /api/mx/trend 200")
    void getTrend_SHOULD_return_status_200_WHENEVER() throws Exception {
        String condition = "?departments=ASSY&departments=PACK&start=2025-01-01&end=2025-01-31";
        perform(getRequest(baseUrl + "/api/mx/trend" + condition))
                .andExpect(status().isOk());
    }

    @Test
    @DisplayName("GET /api/mx/trend 200 (ë‹¨ì¼ ë¶€ì„œ)")
    void getTrend_SINGLE_DEPT_SHOULD_return_status_200_WHENEVER() throws Exception {
        String condition = "?departments=ASSY&start=2025-02-01&end=2025-02-28";
        perform(getRequest(baseUrl + "/api/mx/trend" + condition))
                .andExpect(status().isOk());
    }
}