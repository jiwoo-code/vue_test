<template>
  <div class="virtual-combo-select">
    <!-- 컨트롤 영역 -->
    <div class="vcs-control" @click.stop="toggleDropdown">
      <span v-if="summaryText" class="vcs-summary">
        {{ summaryText }}
      </span>
      <span v-else class="vcs-summary vcs-placeholder">
        {{ placeholder }}
      </span>

      <!-- 화살표 아이콘 (inline svg) -->
      <i class="vcs-arrow-icon" :class="{ open: isOpen }">
        <svg
          focusable="false"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 30 30"
        >
          <polygon
            points="15.1 23.3 2.3 10.5 3.3 9.5 15.1 21.2 26.8 9.5 27.9 10.5 15.1 23.3"
          ></polygon>
        </svg>
      </i>
    </div>

    <!-- 드롭다운 -->
    <div v-if="isOpen" class="vcs-dropdown">
      <!-- 검색 영역 -->
      <template v-if="searchable">
        <input
          v-model="keyword"
          type="text"
          class="vcs-search-input"
          :placeholder="searchPlaceholder"
          @click.stop
        />
      </template>

      <!-- 멀티일 때만 Select All -->
      <div
        v-if="multiple"
        class="vcs-option-row vcs-select-all-row"
        @click.stop="onSelectAllClick"
      >
        <!-- Select All 체크박스 -->
        <i
          class="vcs-checkbox"
          @click.stop.prevent="onSelectAllClick"
        >
          <!-- 언체크 -->
          <svg
            v-if="!isAllSelected && !isPartiallySelected"
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 30 30"
          >
            <path d="M0 0 H30 V30 H0 V0 L2 2 V28 H28 V2 H2 L0 0Z"></path>
          </svg>

          <!-- 전체 체크 -->
          <svg
            v-else-if="isAllSelected"
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 30 30"
          >
            <rect
              x="1.5"
              y="1.5"
              width="27"
              height="27"
              fill="#000000"
              stroke="#000000"
              stroke-width="2"
            />
            <polyline
              points="7,16 13,22 23,8"
              fill="none"
              stroke="#ffffff"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>

          <!-- 일부 선택 -->
          <svg
            v-else
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 30 30"
          >
            <path
              d="M30,0h-1.9H1.9H0v1.9V30h1.9h26.2H30v-1.9V0z M28.1,28.1H1.9V1.9h26.2V28.1z"
            ></path>
            <rect x="8" y="8" width="13.9" height="13.9"></rect>
          </svg>
        </i>

        <span
          class="vcs-option-label"
          :class="selectAllLabelClass"
        >
          전체 선택
        </span>
      </div>

      <!-- 리스트 (가상 스크롤) -->
      <RecycleScroller
        class="vcs-options"
        :items="filteredItems"
        :item-size="ITEM_ROW_HEIGHT"
        key-field="id"
      >
        <template v-slot="{ item }">
          <div
            class="vcs-option-row"
            :class="rowClassForItem(item)"
            @click.stop="onRowClick(item)"
          >
            <!-- 멀티 셀렉트일 때만 체크박스 -->
            <i
              v-if="multiple"
              class="vcs-checkbox"
              @click.stop.prevent="onRowClick(item)"
            >
              <!-- 언체크 -->
              <svg
                v-if="!isChecked(item)"
                focusable="false"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 30 30"
              >
                <path d="M0 0 H30 V30 H0 V0 L2 2 V28 H28 V2 H2 L0 0Z"></path>
              </svg>

              <!-- 체크 -->
              <svg
                v-else
                focusable="false"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 30 30"
              >
                <rect
                  x="1.5"
                  y="1.5"
                  width="27"
                  height="27"
                  fill="#000000"
                  stroke="#000000"
                  stroke-width="2"
                />
                <polyline
                  points="7,16 13,22 23,8"
                  fill="none"
                  stroke="#ffffff"
                  stroke-width="3"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </i>

            <!-- 라벨 -->
            <span
              class="vcs-option-label"
              :class="labelClassForItem(item)"
            >
              {{ item.label }}
            </span>
          </div>
        </template>
      </RecycleScroller>
    </div>
  </div>
</template>