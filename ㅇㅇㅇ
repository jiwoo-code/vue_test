with
params as (
    select
        'PAXV813'::text as eqp_id
      , '2026-01-13 11:15:21'::timestamp as start_ts
      , '2026-01-13 12:15:21'::timestamp as end_ts
),
eqp as (
    select
        p.eqp_id
      , p.eqp_model_name
    from photo_eqp_info p
    join params x
    on p.eqp_id = x.eqp_id
    where p.use_yn = 'Y'
),
sy_raw as (
    select
        s.lot_id
      , s.slot_seq
      , s.module_name
      , s.info_name
      , s.process_start_tmstp
      , s.process_end_tmstp
      , s.process_tmstp
    from eqp_prod_sy_map_hist s
    join params x
    on s.eqp_id = x.eqp_id
    where s.process_tmstp >= x.start_ts - interval '4 hours'
    and s.process_tmstp <= x.end_ts + interval '4 hours'
),
sy_with_order as (
    select
        s.lot_id
      , s.slot_seq
      , s.module_name
      , s.info_name
      , s.process_start_tmstp
      , s.process_end_tmstp
      , m."order"
    from sy_raw s
    cross join eqp e
    left join prism_common.sy_info m
    on m.eqp_model_name = e.eqp_model_name
    and m.module_name = s.module_name
    and m.info_name = s.info_name
),
sy_filtered as (
    select
        s.lot_id
      , s.slot_seq::text as slot_seq
      , s.module_name
      , s.info_name
      , s.process_start_tmstp
      , s.process_end_tmstp
      , s."order"
    from sy_with_order s
    join params x
    on 1 = 1
    where s.process_start_tmstp >= x.start_ts
    and s.process_start_tmstp <= x.end_ts
),
prod_raw as (
    select
        p.wafer_seq
      , p.lot_id
      , p.slot_seq::text as slot_seq
      , p.step_id
      , p.reticle_id
      , p.chuck_id
      , p.exp_start_tmstp
      , p.exp_finish_tmstp
      , p.status
      , p.wafer_exp_sec
      , p.layer_id
      , p.device_id
      , p.as_on_tmstp
      , p.as_off_tmstp
      , p.ts_on_tmstp
      , p.ts_off_tmstp
      , p.arr_on_tmstp
      , p.arr_off_tmstp
      , p.trr_on_tmstp
      , p.trr_off_tmstp
    from eqp_prod_std_wafer_hist p
    join params x
    on p.eqp_id = x.eqp_id
    where p.exp_start_tmstp >= x.start_ts
    and p.exp_start_tmstp <= x.end_ts
),
prod_with_swap as (
    select
        p.*
      , extract(epoch from (p.exp_start_tmstp - lag(p.exp_finish_tmstp) over (order by p.exp_start_tmstp))) as swap_time
    from prod_raw p
),
only_prod_die_exposure as (
    select
        p.lot_id
      , p.slot_seq
      , 'E-chuck'::text as module_name
      , 'Die exposure'::text as info_name
      , p.exp_start_tmstp as process_start_tmstp
      , p.exp_finish_tmstp as process_end_tmstp
      , null::int as "order"
    from prod_with_swap p
    where not exists (
        select
            1
        from sy_filtered s
        where s.lot_id = p.lot_id
        and s.slot_seq = p.slot_seq
        and s.info_name in ('Die exposure', 'Die exposuer')
    )
),
track_signal_events as (
    select
        lot_id
      , slot_seq
      , 'Track Signal'::text as module_name
      , 'AS'::text as info_name
      , as_on_tmstp as process_start_tmstp
      , as_off_tmstp as process_end_tmstp
      , null::int as "order"
    from prod_with_swap
    where as_on_tmstp is not null
    and as_off_tmstp is not null

    union all
    select
        lot_id
      , slot_seq
      , 'Track Signal'::text as module_name
      , 'TS'::text as info_name
      , ts_on_tmstp as process_start_tmstp
      , ts_off_tmstp as process_end_tmstp
      , null::int as "order"
    from prod_with_swap
    where ts_on_tmstp is not null
    and ts_off_tmstp is not null

    union all
    select
        lot_id
      , slot_seq
      , 'Track Signal'::text as module_name
      , 'ARR'::text as info_name
      , arr_on_tmstp as process_start_tmstp
      , arr_off_tmstp as process_end_tmstp
      , null::int as "order"
    from prod_with_swap
    where arr_on_tmstp is not null
    and arr_off_tmstp is not null

    union all
    select
        lot_id
      , slot_seq
      , 'Track Signal'::text as module_name
      , 'TRR'::text as info_name
      , trr_on_tmstp as process_start_tmstp
      , trr_off_tmstp as process_end_tmstp
      , null::int as "order"
    from prod_with_swap
    where trr_on_tmstp is not null
    and trr_off_tmstp is not null
),
events as (
    select
        'sy'::text as src
      , lot_id
      , slot_seq
      , module_name
      , info_name
      , process_start_tmstp
      , process_end_tmstp
      , "order"
    from sy_filtered

    union all
    select
        'only_prod'::text as src
      , lot_id
      , slot_seq
      , module_name
      , info_name
      , process_start_tmstp
      , process_end_tmstp
      , "order"
    from only_prod_die_exposure

    union all
    select
        'track'::text as src
      , lot_id
      , slot_seq
      , module_name
      , info_name
      , process_start_tmstp
      , process_end_tmstp
      , "order"
    from track_signal_events
),
events_timecalc as (
    select
        e.src
      , e.lot_id
      , e.slot_seq
      , e.module_name
      , e.info_name
      , e.process_start_tmstp
      , e.process_end_tmstp
      , e."order"
      , extract(epoch from (
            e.process_start_tmstp
            - lag(e.process_end_tmstp) over (
                partition by e.info_name
                order by e.process_start_tmstp
            )
        )) as interval
      , extract(epoch from (e.process_end_tmstp - e.process_start_tmstp)) as duration
    from events e
),
prod_display as (
    select
        lot_id
      , slot_seq
      , chuck_id
      , step_id
      , reticle_id
      , swap_time
      , exp_start_tmstp
      , exp_finish_tmstp
      , status
      , wafer_exp_sec
      , wafer_seq
      , layer_id
      , device_id
    from prod_with_swap
),
loss_items as (
    select
        w.wafer_seq
      , w.result_name || '[' || coalesce(round(w.loss_time::numeric, 3)::text, '0') || ']' as loss_item
    from anal_algrth_wst_result_hist w
    join params x
    on w.eqp_id = x.eqp_id
    where w.summary_date between x.start_ts::date - interval '1 day' and x.end_ts::date + interval '1 day'

    union all

    select
        l.wafer_seq
      , l.result_name || '[' || coalesce(round(l.loss_time::numeric, 3)::text, '0') || ']' as loss_item
    from prism_ops.anal_algrth_loh_result_hist l
    join params x
    on l.eqp_id = x.eqp_id
    where l.summary_date between x.start_ts::date - interval '1 day' and x.end_ts::date + interval '1 day'
),
loss_by_wafer as (
    select
        wafer_seq
      , string_agg(loss_item, ', ' order by loss_item) as loss
    from loss_items
    group by wafer_seq
)
select
    e.lot_id
  , e.slot_seq
  , e.module_name
  , e.info_name
  , e.process_start_tmstp
  , e.process_end_tmstp
  , e."order"
  , e.interval
  , e.duration
  , p.chuck_id
  , p.step_id
  , p.reticle_id
  , p.swap_time
  , p.exp_start_tmstp
  , p.exp_finish_tmstp
  , p.status
  , p.wafer_exp_sec
  , p.wafer_seq
  , p.layer_id
  , p.device_id
  , lbw.loss
from events_timecalc e
left join prod_display p
on p.lot_id = e.lot_id
and p.slot_seq = e.slot_seq
left join loss_by_wafer lbw
on lbw.wafer_seq = p.wafer_seq
order by
    e.process_start_tmstp
  , e.src
  , e.lot_id
  , e.slot_seq
  , e.info_name;