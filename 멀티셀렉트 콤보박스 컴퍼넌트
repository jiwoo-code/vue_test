<template>
  <div
    class="virtual-combo-select"
    :style="{ width: typeof width === 'number' ? width + 'px' : width }"
  >
    <div class="vcs-control" @click.stop="toggleDropdown">
      <span v-if="summaryText" class="vcs-summary">
        {{ summaryText }}
      </span>
      <span v-else class="vcs-summary vcs-placeholder">
        {{ placeholder }}
      </span>

      <i class="vcs-arrow-icon" :class="{ open: isOpen }">
        <svg
          focusable="false"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 30 30"
        >
          <polygon
            points="15.1 23.3 2.3 10.5 3.3 9.5 15.1 21.2 26.8 9.5 27.9 10.5 15.1 23.3"
          />
        </svg>
      </i>
    </div>

    <div v-if="isOpen" class="vcs-dropdown">
      <input
        v-if="searchable"
        v-model="keyword"
        type="text"
        class="vcs-search-input"
        :placeholder="searchPlaceholder"
        @click.stop
      />

      <div
        v-if="multiple"
        class="vcs-option-row vcs-select-all-row"
        @click.stop="onSelectAllClick"
      >
        <i
          class="vcs-checkbox"
          :class="selectAllCheckboxClass"
          @click.stop.prevent="onSelectAllClick"
        >
          <svg
            v-if="selectAllCheckboxClass === 'is-unchecked'"
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 30 30"
          >
            <path
              d="M0 0 H30 V30 H0 V0 L2 2 V28 H28 V2 H2 L0 0Z"
              fill="currentColor"
            />
          </svg>

          <svg
            v-else-if="selectAllCheckboxClass === 'is-checked'"
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 37 37"
          >
            <polygon
              points="0 37 37 37 37 0 0 0 0 37 14.6 28.3 5 18.7 7.1 16.6 14.7 24.1 29.9 9.7 32 11.9 14.6 28.3"
              fill="currentColor"
            />
          </svg>

          <svg
            v-else
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 30 30"
          >
            <path
              d="M30,0h-1.9H1.9H0v1.9V30h1.9h26.2H30v-1.9V0z M28.1,28.1H1.9V1.9h26.2V28.1z"
              fill="currentColor"
            />
            <rect
              x="8"
              y="8"
              width="13.9"
              height="13.9"
              fill="currentColor"
            />
          </svg>
        </i>

        <span
          class="vcs-option-label"
          :class="selectAllLabelClass"
        >
          Select All
        </span>
      </div>

      <RecycleScroller
        class="vcs-options"
        :items="filteredItems"
        :item-size="28"
        key-field="id"
      >
        <template v-slot="{ item }">
          <div
            class="vcs-option-row"
            :class="rowClassForItem(item)"
            @click.stop="onRowClick(item)"
          >
            <i
              v-if="multiple"
              class="vcs-checkbox"
              :class="checkboxClassForItem(item)"
              @click.stop.prevent="onRowClick(item)"
            >
              <svg
                v-if="!isChecked(item)"
                focusable="false"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 30 30"
              >
                <path
                  d="M0 0 H30 V30 H0 V0 L2 2 V28 H28 V2 H2 L0 0Z"
                  fill="currentColor"
                />
              </svg>

              <svg
                v-else
                focusable="false"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 37 37"
              >
                <polygon
                  points="0 37 37 37 37 0 0 0 0 37 14.6 28.3 5 18.7 7.1 16.6 14.7 24.1 29.9 9.7 32 11.9 14.6 28.3"
                  fill="currentColor"
                />
              </svg>
            </i>

            <span
              class="vcs-option-label"
              :class="labelClassForItem(item)"
            >
              {{ item.label }}
            </span>
          </div>
        </template>
      </RecycleScroller>
    </div>
  </div>
</template>

<script>
import { RecycleScroller } from 'vue-virtual-scroller'
import 'vue-virtual-scroller/dist/vue-virtual-scroller.css'

export default {
  name: 'VirtualComboSelect',
  components: {
    RecycleScroller
  },
  props: {
    /**
     * 컴포넌트 전체 가로너비
     * 숫자: px 단위 (예: 320 -> 320px)
     * 문자열: 그대로 적용 (예: '100%', '24rem')
     */
    width: {
      type: [String, Number],
      default: 320
    },
    /**
     * v-model 값
     * multiple=true: Array
     * multiple=false: 단일 값(id)
     */
    value: {
      type: [Array, String, Number, Object, null],
      default: null
    },
    /**
     * 콤보박스 항목 목록
     * [{ id, label }, ...] 형태
     */
    items: {
      type: Array,
      required: true
    },
    /**
     * 멀티 선택 여부
     */
    multiple: {
      type: Boolean,
      default: false
    },
    /**
     * 항목 미선택 시 표시할 플레이스홀더
     */
    placeholder: {
      type: String,
      default: 'Select'
    },
    /**
     * 검색 인풋 플레이스홀더
     */
    searchPlaceholder: {
      type: String,
      default: '검색...'
    },
    /**
     * 검색 기능 사용 여부
     * true면 검색 인풋 표시
     */
    searchable: {
      type: Boolean,
      default: true
    }
  },
  data() {
    return {
      /**
       * 드롭다운 열림 상태
       */
      isOpen: false,
      /**
       * 검색어
       */
      keyword: '',
      /**
       * 선택 상태를 관리하는 Set
       */
      selectedSet: new Set()
    }
  },
  watch: {
    /**
     * v-model 값 변경 시 내부 Set과 동기화한다.
     */
    value: {
      immediate: true,
      handler(newValue) {
        const nextSet = new Set()

        if (this.multiple) {
          if (Array.isArray(newValue)) {
            for (let index = 0; index < newValue.length; index += 1) {
              nextSet.add(newValue[index])
            }
          }
        } else {
          if (newValue !== null && newValue !== undefined) {
            nextSet.add(newValue)
          }
        }

        this.selectedSet = nextSet
      }
    }
  },
  computed: {
    /**
     * 검색 활성 상태인지 여부를 반환한다.
     * searchable=true이고 keyword가 공백이 아닌 경우
     */
    isFilteringActive() {
      if (!this.searchable) {
        return false
      }
      return this.keyword.trim().length > 0
    },
    /**
     * 선택된 id를 배열로 반환한다.
     */
    normalizedSelectedIds() {
      return Array.from(this.selectedSet)
    },
    /**
     * 검색어가 반영된 항목 목록을 반환한다.
     */
    filteredItems() {
      if (!this.searchable) {
        return this.items
      }

      const trimmed = this.keyword.trim()
      if (!trimmed) {
        return this.items
      }

      const lower = trimmed.toLowerCase()
      return this.items.filter(item => {
        let label = ''
        if (item && item.label !== undefined && item.label !== null) {
          label = String(item.label)
        }
        return label.toLowerCase().indexOf(lower) !== -1
      })
    },
    /**
     * 컨트롤 영역에 표시할 요약 텍스트를 반환한다.
     * 싱글: 선택된 항목 라벨
     * 멀티: 최대 7개 라벨 표시 후 초과 시 "..." 추가
     */
    summaryText() {
      const selectedIds = this.normalizedSelectedIds
      const count = selectedIds.length

      if (count === 0) {
        return ''
      }

      if (!this.multiple) {
        const selectedId = selectedIds[0]
        const found = this.items.find(item => item.id === selectedId)
        if (found && found.label !== undefined && found.label !== null) {
          return String(found.label)
        }
        return String(selectedId)
      }

      const maxCount = 7
      const labels = []
      const limit = Math.min(count, maxCount)

      for (let index = 0; index < limit; index += 1) {
        const id = selectedIds[index]
        const found = this.items.find(item => item.id === id)

        if (found && found.label !== undefined && found.label !== null) {
          labels.push(String(found.label))
        } else {
          labels.push(String(id))
        }
      }

      let text = labels.join(', ')
      if (count > maxCount) {
        text += ', ...'
      }

      return text
    },
    /**
     * 전체 항목 수를 반환한다.
     */
    totalCount() {
      return this.items.length
    },
    /**
     * 선택된 항목 수를 반환한다.
     */
    selectedCount() {
      return this.selectedSet.size
    },
    /**
     * 필터링된 항목 수를 반환한다.
     */
    filteredCount() {
      return this.filteredItems.length
    },
    /**
     * 필터링된 항목 중 선택된 항목 수를 반환한다.
     */
    selectedInFilteredCount() {
      if (this.selectedSet.size === 0) {
        return 0
      }

      let count = 0
      for (let index = 0; index < this.filteredItems.length; index += 1) {
        const item = this.filteredItems[index]
        if (this.selectedSet.has(item.id)) {
          count += 1
        }
      }
      return count
    },
    /**
     * 전체 선택 여부를 반환한다.
     * 검색 중에는 필터된 항목 기준으로 판단한다.
     */
    isAllSelected() {
      if (this.isFilteringActive) {
        return (
          this.filteredCount > 0 &&
          this.selectedInFilteredCount === this.filteredCount
        )
      }

      return this.totalCount > 0 && this.selectedCount === this.totalCount
    },
    /**
     * 일부 선택 상태인지 여부를 반환한다.
     * 검색 중에는 필터된 항목 기준으로 판단한다.
     */
    isPartiallySelected() {
      if (this.isFilteringActive) {
        return (
          this.selectedInFilteredCount > 0 &&
          this.selectedInFilteredCount < this.filteredCount
        )
      }

      return (
        this.selectedCount > 0 &&
        this.selectedCount < this.totalCount
      )
    },
    /**
     * Select All 체크박스 클래스명을 반환한다.
     */
    selectAllCheckboxClass() {
      if (this.isAllSelected) {
        return 'is-checked'
      }
      if (this.isPartiallySelected) {
        return 'is-partially-checked'
      }
      return 'is-unchecked'
    },
    /**
     * Select All 라벨 클래스명을 반환한다.
     */
    selectAllLabelClass() {
      if (this.isAllSelected || this.isPartiallySelected) {
        return 'is-checked'
      }
      return 'is-unchecked'
    }
  },
  methods: {
    /**
     * 드롭다운 열림 상태를 토글한다.
     */
    toggleDropdown() {
      this.isOpen = !this.isOpen
    },
    /**
     * 드롭다운을 닫는다.
     */
    closeDropdown() {
      this.isOpen = false
    },
    /**
     * 항목이 선택되었는지 여부를 반환한다.
     */
    isChecked(item) {
      return this.selectedSet.has(item.id)
    },
    /**
     * 행 클래스명을 반환한다.
     * 멀티: is-selected
     * 싱글: is-selected-single
     */
    rowClassForItem(item) {
      if (!this.isChecked(item)) {
        return {}
      }

      if (this.multiple) {
        return { 'is-selected': true }
      }

      return { 'is-selected-single': true }
    },
    /**
     * 행 클릭 시 선택 상태를 토글한다.
     * 멀티: Set 기반으로 추가/제거 후 배열로 emit
     * 싱글: 단일 선택 토글 후 닫기
     */
    onRowClick(item) {
      if (this.multiple) {
        const nextSet = new Set(this.selectedSet)

        if (nextSet.has(item.id)) {
          nextSet.delete(item.id)
        } else {
          nextSet.add(item.id)
        }

        this.selectedSet = nextSet
        const nextArray = Array.from(nextSet)
        this.$emit('input', nextArray)
        this.$emit('change', nextArray)
        return
      }

      const nextSet = new Set()
      let nextValue = item.id

      if (this.selectedSet.has(item.id)) {
        nextValue = null
      } else {
        nextSet.add(item.id)
      }

      this.selectedSet = nextSet
      this.$emit('input', nextValue)
      this.$emit('change', nextValue)
      this.closeDropdown()
    },
    /**
     * Select All 클릭 시 전체 선택 또는 해제를 수행한다.
     * 검색 중에는 필터된 항목만 대상으로 동작한다.
     * [성능 최적화] map 사용을 제거하고 직접 순회하여 대용량 데이터 시 프리징 방지
     */
    onSelectAllClick() {
      if (!this.multiple) {
        return
      }

      // 검색 활성화 상태
      if (this.isFilteringActive) {
        const nextSet = new Set(this.selectedSet)
        // filteredItems.map을 제거하고 직접 배열을 순회 (메모리 할당 및 순회 비용 감소)
        const items = this.filteredItems
        const isAll = this.isAllSelected
        const len = items.length

        if (isAll) {
          // 전체 해제
          for (let index = 0; index < len; index += 1) {
            nextSet.delete(items[index].id)
          }
        } else {
          // 전체 선택
          for (let index = 0; index < len; index += 1) {
            nextSet.add(items[index].id)
          }
        }

        this.selectedSet = nextSet
        const nextArray = Array.from(nextSet)
        this.$emit('input', nextArray)
        this.$emit('change', nextArray)
        return
      }

      // 검색어가 없을 때
      if (this.isAllSelected) {
        this.selectedSet = new Set()
        this.$emit('input', [])
        this.$emit('change', [])
        return
      }

      // map을 사용하지 않고 전체 항목을 직접 순회하여 추가
      const items = this.items
      const len = items.length
      const filledSet = new Set()
      
      for (let index = 0; index < len; index += 1) {
        filledSet.add(items[index].id)
      }

      this.selectedSet = filledSet
      const nextArray = Array.from(filledSet)
      this.$emit('input', nextArray)
      this.$emit('change', nextArray)
    },
    /**
     * 항목별 체크박스 클래스명을 반환한다.
     */
    checkboxClassForItem(item) {
      return this.isChecked(item) ? 'is-checked' : 'is-unchecked'
    },
    /**
     * 항목 라벨 클래스명을 반환한다.
     * 멀티: 선택 시 굵게
     * 싱글: 선택 시 흰색 글자
     */
    labelClassForItem(item) {
      if (!this.isChecked(item)) {
        return 'is-unchecked'
      }

      if (this.multiple) {
        return 'is-checked'
      }

      return 'is-single-selected'
    },
    /**
     * 컴포넌트 밖을 클릭하면 드롭다운을 닫는다.
     */
    handleClickOutside(event) {
      if (!this.$el.contains(event.target)) {
        this.closeDropdown()
      }
    }
  },
  mounted() {
    document.addEventListener('click', this.handleClickOutside)
  },
  beforeDestroy() {
    document.removeEventListener('click', this.handleClickOutside)
  }
}
</script>

<style scoped>
.virtual-combo-select {
  position: relative;
  font-size: 12px;
  margin-bottom: 24px;
}

/* 컨트롤 영역 */
.vcs-control {
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 32px;
  padding: 4px 8px;
  border: 1px solid #bdbdbd;
  border-radius: 0;
  cursor: pointer;
  background-color: #ffffff;
}

/* 컨트롤 hover 시 테두리 검정 */
.vcs-control:hover {
  border: 1px solid #000000;
}

.vcs-placeholder {
  color: #aaaaaa;
}

.vcs-summary {
  flex: 1;
  margin-right: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #444444;
  font-size: 12px;
}

/* 화살표 아이콘 */
.vcs-arrow-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  transition-duration: 0.3s;
  transform: rotate(0deg);
}

.vcs-arrow-icon svg {
  width: 10px;
  height: 10px;
  fill: #444444;
}

.vcs-arrow-icon.open {
  transform: rotate(-180deg);
}

/* 드롭다운 */
.vcs-dropdown {
  position: absolute;
  z-index: 2000;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: 4px;
  border: 1px solid #000000;
  border-radius: 0;
  background-color: #ffffff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* 검색 인풋 */
.vcs-search-input {
  width: 100%;
  box-sizing: border-box;
  padding: 4px 8px;
  border: 0;
  border-bottom: 1px solid #eeeeee;
  outline: none;
  font-size: 12px;
}

/* 리스트 */
.vcs-options {
  max-height: 260px;
  width: 100%;
}

/* 각 행 */
.vcs-option-row {
  display: block;
  padding: 0 8px;
  height: 28px;
  box-sizing: border-box;
  cursor: pointer;
  width: 100%;
}

/* 행 hover 시 배경 */
.vcs-option-row:hover {
  background-color: #e6e6e6;
}

/* Select All 행 */
.vcs-select-all-row {
  border-bottom: 1px solid #000000;
  padding: 6px 8px;
  height: auto;
}

/* 싱글 선택 행 */
.vcs-option-row.is-selected-single {
  background-color: #000000;
}

.vcs-option-row.is-selected-single:hover {
  background-color: #000000;
}

/* 체크박스 */
.vcs-checkbox {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  font-size: 16px;
  line-height: 16px;
  cursor: pointer;
  vertical-align: middle;
}

/* 체크 상태 색상 */
.vcs-checkbox.is-unchecked {
  color: #a5a5a5;
}

.vcs-checkbox.is-checked,
.vcs-checkbox.is-partially-checked {
  color: #000000;
}

.vcs-checkbox svg {
  width: 16px;
  height: 16px;
}

/* 라벨 */
.vcs-option-label {
  margin-left: 8px;
  font-size: 12px;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  font-family: 'NoteSans', Arial, sans-serif !important;
  line-height: 18px;
  vertical-align: middle;
}

/* 멀티: 체크된 라벨 */
.vcs-option-label.is-checked {
  color: #444444;
  font-weight: 600;
}

/* 싱글: 선택된 라벨 */
.vcs-option-label.is-single-selected {
  color: #ffffff;
  font-weight: 400;
}

/* 체크 해제 라벨 */
.vcs-option-label.is-unchecked {
  color: #333333;
  font-weight: 400;
}
</style>
