with
params as (
    select
        'PAXV813'::text as eqp_id
      , '2026-01-13 11:15:21'::timestamp as start_ts
      , '2026-01-13 12:15:21'::timestamp as end_ts
),
prod_wafer as (
    select distinct
        p.wafer_seq
    from eqp_prod_std_wafer_hist p
    join params x
    on p.eqp_id = x.eqp_id
    where p.exp_start_tmstp >= x.start_ts
    and p.exp_start_tmstp <= x.end_ts
    and p.wafer_seq is not null
),
loh_wafer as (
    select distinct
        l.wafer_seq
    from prism_ops.anal_algrth_loh_result_hist l
    join params x
    on l.eqp_id = x.eqp_id
    join prod_wafer pw
    on pw.wafer_seq = l.wafer_seq
    where l.summary_date between x.start_ts::date - interval '1 day' and x.end_ts::date + interval '1 day'
),
loh_list_by_wafer as (
    with loh_items as (
        select
            l.wafer_seq
          , l.result_name
          , coalesce(round(l.loss_time::numeric, 3), 0::numeric) as loss_time_rounded
        from prism_ops.anal_algrth_loh_result_hist l
        join params x
        on l.eqp_id = x.eqp_id
        join loh_wafer lw
        on lw.wafer_seq = l.wafer_seq
        where l.summary_date between x.start_ts::date - interval '1 day' and x.end_ts::date + interval '1 day'
    ),
    loh_items_text as (
        select
            wafer_seq
          , (result_name
            || '['
            || case
                    when position('.' in normalized) = 0 then normalized || '.0'
                    else normalized
               end
            || ']') as loss_item
        from (
            select
                wafer_seq
              , result_name
              , regexp_replace(
                    regexp_replace(
                        regexp_replace(loss_time_rounded::text, '(\.\d*?)0+$', '\1'),
                        '\.$',
                        ''
                    ),
                    '^$',
                    '0'
                ) as normalized
            from loh_items
        ) t
    )
    select
        wafer_seq
      , '[' || string_agg(quote_literal(loss_item), ', ' order by loss_item) || ']' as loss
    from loh_items_text
    group by wafer_seq
),
wst_text_by_wafer as (
    with wst_items as (
        select
            w.wafer_seq
          , w.result_name
          , coalesce(round(w.loss_time::numeric, 3), 0::numeric) as loss_time_rounded
        from anal_algrth_wst_result_hist w
        join params x
        on w.eqp_id = x.eqp_id
        join loh_wafer lw
        on lw.wafer_seq = w.wafer_seq
        where w.summary_date between x.start_ts::date - interval '1 day' and x.end_ts::date + interval '1 day'
    ),
    wst_items_text as (
        select
            wafer_seq
          , (result_name
            || '['
            || case
                    when position('.' in normalized) = 0 then normalized || '.0'
                    else normalized
               end
            || ']') as loss_text
        from (
            select
                wafer_seq
              , result_name
              , regexp_replace(
                    regexp_replace(
                        regexp_replace(loss_time_rounded::text, '(\.\d*?)0+$', '\1'),
                        '\.$',
                        ''
                    ),
                    '^$',
                    '0'
                ) as normalized
            from wst_items
        ) t
    )
    select
        wafer_seq
      , min(loss_text) as wst_loss_text
    from wst_items_text
    group by wafer_seq
)
select
    lw.wafer_seq
  , wst.wst_loss_text
  , loh.loss as loh_list_loss
  , case
        when loh.loss is not null then loh.loss
        else wst.wst_loss_text
    end as final_loss_should_be
from loh_wafer lw
left join loh_list_by_wafer loh
on loh.wafer_seq = lw.wafer_seq
left join wst_text_by_wafer wst
on wst.wafer_seq = lw.wafer_seq
order by
    lw.wafer_seq;