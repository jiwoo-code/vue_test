<template>
  <div class="virtual-combo-select">
    <!-- 컨트롤 영역 -->
    <div class="vcs-control" @click.stop="toggleDropdown">
      <span v-if="summaryText" class="vcs-summary">
        {{ summaryText }}
      </span>
      <span v-else class="vcs-summary vcs-placeholder">
        {{ placeholder }}
      </span>

      <!-- 화살표 아이콘 (inline svg) -->
      <i class="vcs-arrow-icon" :class="{ open: isOpen }">
        <svg
          focusable="false"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 30 30"
        >
          <polygon
            points="15.1 23.3 2.3 10.5 3.3 9.5 15.1 21.2 26.8 9.5 27.9 10.5 15.1 23.3"
          ></polygon>
        </svg>
      </i>
    </div>

    <!-- 드롭다운 -->
    <div v-if="isOpen" class="vcs-dropdown">
      <!-- 검색 영역 -->
      <template v-if="searchable">
        <input
          v-model="keyword"
          type="text"
          class="vcs-search-input"
          :placeholder="searchPlaceholder"
          @click.stop
        />
      </template>

      <!-- 멀티일 때만 Select All -->
      <div
        v-if="multiple"
        class="vcs-option-row vcs-select-all-row"
        @click.stop="onSelectAllClick"
      >
        <!-- Select All 체크박스 -->
        <i
          class="vcs-checkbox"
          @click.stop.prevent="onSelectAllClick"
        >
          <!-- 언체크 -->
          <svg
            v-if="!isAllSelected && !isPartiallySelected"
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 30 30"
          >
            <path d="M0 0 H30 V30 H0 V0 L2 2 V28 H28 V2 H2 L0 0Z"></path>
          </svg>

          <!-- 전체 체크 -->
          <svg
            v-else-if="isAllSelected"
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 30 30"
          >
            <rect
              x="1.5"
              y="1.5"
              width="27"
              height="27"
              fill="#000000"
              stroke="#000000"
              stroke-width="2"
            />
            <polyline
              points="7,16 13,22 23,8"
              fill="none"
              stroke="#ffffff"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>

          <!-- 일부 선택 -->
          <svg
            v-else
            focusable="false"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 30 30"
          >
            <path
              d="M30,0h-1.9H1.9H0v1.9V30h1.9h26.2H30v-1.9V0z M28.1,28.1H1.9V1.9h26.2V28.1z"
            ></path>
            <rect x="8" y="8" width="13.9" height="13.9"></rect>
          </svg>
        </i>

        <span
          class="vcs-option-label"
          :class="selectAllLabelClass"
        >
          전체 선택
        </span>
      </div>

      <!-- 리스트 (가상 스크롤) -->
      <RecycleScroller
        class="vcs-options"
        :items="filteredItems"
        :item-size="ITEM_ROW_HEIGHT"
        key-field="id"
      >
        <template v-slot="{ item }">
          <div
            class="vcs-option-row"
            :class="rowClassForItem(item)"
            @click.stop="onRowClick(item)"
          >
            <!-- 멀티 셀렉트일 때만 체크박스 -->
            <i
              v-if="multiple"
              class="vcs-checkbox"
              @click.stop.prevent="onRowClick(item)"
            >
              <!-- 언체크 -->
              <svg
                v-if="!isChecked(item)"
                focusable="false"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 30 30"
              >
                <path d="M0 0 H30 V30 H0 V0 L2 2 V28 H28 V2 H2 L0 0Z"></path>
              </svg>

              <!-- 체크 -->
              <svg
                v-else
                focusable="false"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 30 30"
              >
                <rect
                  x="1.5"
                  y="1.5"
                  width="27"
                  height="27"
                  fill="#000000"
                  stroke="#000000"
                  stroke-width="2"
                />
                <polyline
                  points="7,16 13,22 23,8"
                  fill="none"
                  stroke="#ffffff"
                  stroke-width="3"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </i>

            <!-- 라벨 -->
            <span
              class="vcs-option-label"
              :class="labelClassForItem(item)"
            >
              {{ item.label }}
            </span>
          </div>
        </template>
      </RecycleScroller>
    </div>
  </div>
</template>

<script>
import { RecycleScroller } from 'vue-virtual-scroller'
import 'vue-virtual-scroller/dist/vue-virtual-scroller.css'

const MAX_LABEL_COUNT = 7
const ITEM_ROW_HEIGHT = 28

export default {
  name: 'VirtualComboSelect',
  components: {
    RecycleScroller
  },
  props: {
    value: {
      type: [Array, String, Number, Object, null],
      default: null
    },
    items: {
      type: Array,
      required: true
    },
    multiple: {
      type: Boolean,
      default: false
    },
    placeholder: {
      type: String,
      default: '선택하세요'
    },
    searchPlaceholder: {
      type: String,
      default: '검색...'
    },
    searchable: {
      type: Boolean,
      default: true
    }
  },
  data() {
    return {
      isOpen: false,
      keyword: ''
    }
  },
  computed: {
    itemMap() {
      const map = {}
      for (let index = 0; index < this.items.length; index += 1) {
        const item = this.items[index]
        map[item.id] = item
      }
      return map
    },
    normalizedSelectedIds() {
      if (this.multiple) {
        return Array.isArray(this.value) ? this.value : []
      }
      if (this.value === null || this.value === undefined) {
        return []
      }
      return [this.value]
    },
    filteredItems() {
      if (!this.searchable) {
        return this.items
      }
      const kw = this.keyword.trim().toLowerCase()
      if (!kw) return this.items
      return this.items.filter(item =>
        String(item.label || '').toLowerCase().includes(kw)
      )
    },
    summaryText() {
      const ids = this.normalizedSelectedIds
      const count = ids.length
      if (count === 0) return ''

      if (!this.multiple) {
        const id = ids[0]
        const item = this.itemMap[id]
        return item ? String(item.label) : String(id)
      }

      const labels = []
      const limit = Math.min(count, MAX_LABEL_COUNT)
      for (let index = 0; index < limit; index += 1) {
        const id = ids[index]
        const item = this.itemMap[id]
        labels.push(item ? String(item.label) : String(id))
      }

      let text = labels.join(', ')
      if (count > MAX_LABEL_COUNT) text += ', ...'
      return text
    },
    totalCount() {
      return this.items.length
    },
    selectedCount() {
      return this.normalizedSelectedIds.length
    },
    isAllSelected() {
      return this.totalCount > 0 && this.selectedCount === this.totalCount
    },
    isPartiallySelected() {
      return (
        this.selectedCount > 0 &&
        this.selectedCount < this.totalCount
      )
    },
    selectAllLabelClass() {
      if (this.isAllSelected || this.isPartiallySelected) {
        return 'is-checked'
      }
      return 'is-unchecked'
    },
    ITEM_ROW_HEIGHT() {
      return ITEM_ROW_HEIGHT
    }
  },
  methods: {
    toggleDropdown() {
      this.isOpen = !this.isOpen
    },
    closeDropdown() {
      this.isOpen = false
    },
    isChecked(item) {
      return this.normalizedSelectedIds.indexOf(item.id) !== -1
    },
    rowClassForItem(item) {
      if (!this.isChecked(item)) {
        return {}
      }
      if (this.multiple) {
        return { 'is-selected': true }
      }
      return { 'is-selected-single': true }
    },
    onRowClick(item) {
      if (this.multiple) {
        const current = Array.isArray(this.value) ? this.value.slice() : []
        const index = current.indexOf(item.id)
        if (index === -1) {
          current.push(item.id)
        } else {
          current.splice(index, 1)
        }
        this.$emit('input', current)
        this.$emit('change', current)
        return
      }
      const currentId = this.normalizedSelectedIds[0] || null
      const nextValue = currentId === item.id ? null : item.id
      this.$emit('input', nextValue)
      this.$emit('change', nextValue)
      this.closeDropdown()
    },
    onSelectAllClick() {
      if (!this.multiple) return
      if (this.isAllSelected) {
        this.$emit('input', [])
        this.$emit('change', [])
        return
      }
      const allIds = this.items.map(item => item.id)
      this.$emit('input', allIds)
      this.$emit('change', allIds)
    },
    labelClassForItem(item) {
      if (!this.isChecked(item)) {
        return 'is-unchecked'
      }
      if (this.multiple) {
        return 'is-checked'
      }
      return 'is-single-selected'
    },
    handleClickOutside(event) {
      if (!this.$el.contains(event.target)) {
        this.closeDropdown()
      }
    }
  },
  mounted() {
    document.addEventListener('click', this.handleClickOutside)
  },
  beforeDestroy() {
    document.removeEventListener('click', this.handleClickOutside)
  }
}
</script>

<style scoped>
.virtual-combo-select {
  position: relative;
  width: 320px;
  font-size: 13px;
  margin-bottom: 24px;
}

/* 컨트롤 영역 */
.vcs-control {
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 32px;
  padding: 4px 8px;
  border: 1px solid #bdbdbd;
  cursor: pointer;
  background-color: #ffffff;
  border-radius: 0;
}

.vcs-summary {
  flex: 1;
  margin-right: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #444444;
}

.vcs-placeholder {
  color: #aaaaaa;
}

/* 화살표 (inline svg) */
.vcs-arrow-icon {
  width: 10px;
  height: 10px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition-duration: 0.3s;
  transform: rotate(0deg);
}

.vcs-arrow-icon svg {
  width: 100%;
  height: 100%;
  fill: #444444;
}

.vcs-arrow-icon.open {
  transform: rotate(-180deg);
}

/* 드롭다운 */
.vcs-dropdown {
  position: absolute;
  z-index: 2000;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: 4px;
  border: 1px solid #000000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  background-color: #ffffff;
  border-radius: 0;
}

/* 검색 */
.vcs-search-input {
  width: 100%;
  padding: 4px 8px;
  border: 0;
  border-bottom: 1px solid #eeeeee;
  outline: none;
  font-size: 13px;
  box-sizing: border-box;
}

/* 리스트 */
.vcs-options {
  max-height: 260px;
  width: 100%;
}

/* 각 row */
.vcs-option-row {
  display: flex;
  align-items: center;
  padding: 2px 8px;
  min-height: 24px;
  cursor: pointer;
  box-sizing: border-box;
  width: 100%;
}

/* hover */
.vcs-option-row:hover {
  background-color: #f0f0f0;
}

/* 싱글 선택 시 – 배경/폰트 반전 */
.vcs-option-row.is-selected-single {
  background-color: #444444;
}

.vcs-option-row.is-selected-single:hover {
  background-color: #444444;
}

/* 체크박스 컨테이너 */
.vcs-checkbox {
  width: 16px;
  height: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.vcs-checkbox svg {
  width: 100%;
  height: 100%;
  fill: #000000;
}

/* 라벨 */
.vcs-option-label {
  margin-left: 8px;
  font-size: 12px;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  font-family: 'NoteSans', Arial, sans-serif !important;
}

/* 멀티: 체크된 라벨 */
.vcs-option-label.is-checked {
  color: #444444;
  font-weight: 600;
}

/* 싱글: 체크된 라벨 (배경 반전에 맞춰 흰색, 굵게 X) */
.vcs-option-label.is-single-selected {
  color: #ffffff;
  font-weight: 400;
}

/* 체크 해제 라벨 */
.vcs-option-label.is-unchecked {
  color: #333333;
  font-weight: 400;
}

/* Select All 구분선 */
.vcs-select-all-row {
  border-bottom: 1px solid #eeeeee;
}
</style>