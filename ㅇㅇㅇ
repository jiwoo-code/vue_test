with
params as (
    select
        'PAXV813'::text as eqp_id
      , '2026-01-13 00:00:00'::timestamp as start_ts
      , '2026-01-14 00:00:00'::timestamp as end_ts
),
eqp as (
    select
        p.eqp_id
      , p.eqp_model_name
      , p.schema_name
      , p.line_group_id
      , p.depart_name
    from photo_eqp_info p
    join params x
    on p.eqp_id = x.eqp_id
    where p.use_yn = 'Y'
),
sy_raw as (
    select
        s.lot_id
      , s.slot_seq
      , s.module_name
      , s.info_name
      , s.process_start_tmstp
      , s.process_end_tmstp
      , s.process_tmstp
    from eqp_prod_sy_map_hist s
    join params x
    on s.eqp_id = x.eqp_id
    where s.process_tmstp >= x.start_ts - interval '4 hours'
    and s.process_tmstp <= x.end_ts + interval '4 hours'
),
sy_with_order as (
    select
        s.lot_id
      , s.slot_seq
      , s.module_name
      , s.info_name
      , s.process_start_tmstp
      , s.process_end_tmstp
      , m."order"
    from sy_raw s
    cross join eqp e
    left join prism_common.sy_info m
    on m.eqp_model_name = e.eqp_model_name
    and m.module_name = s.module_name
    and m.info_name = s.info_name
),
sy_filtered as (
    select
        *
    from sy_with_order s
    join params x
    on 1 = 1
    where s.process_start_tmstp >= x.start_ts
    and s.process_start_tmstp <= x.end_ts
),
prod_raw as (
    select
        p.wafer_seq
      , p.lot_id
      , p.slot_seq
      , p.layer_id
      , p.device_id
      , p.step_id
      , p.reticle_id
      , p.shuck_id as chuck_id
      , p.exp_start_tmstp
      , p.exp_finish_tmstp
      , p.wafer_exp_sec
      , p.status
      , p.as_on_tmstp
      , p.as_off_tmstp
      , p.ts_on_tmstp
      , p.ts_off_tmstp
      , p.arr_on_tmstp
      , p.arr_off_tmstp
      , p.trr_on_tmstp
      , p.trr_off_tmstp
    from eqp_prod_std_wafer_hist p
    join params x
    on p.eqp_id = x.eqp_id
    where p.file_date between x.start_ts::date - interval '1 day' and x.end_ts::date + interval '1 day'
),
prod_filtered as (
    select
        *
    from prod_raw p
    join params x
    on 1 = 1
    where p.exp_start_tmstp >= x.start_ts
    and p.exp_start_tmstp <= x.end_ts
)
select
    'sy'::text as src
  , s.lot_id
  , s.slot_seq
  , s.module_name
  , s.info_name
  , s.process_start_tmstp
  , s.process_end_tmstp
  , s."order"
  , null::bigint as wafer_seq
  , null::timestamp as exp_start_tmstp
  , null::timestamp as exp_finish_tmstp
from sy_filtered s

union all

select
    'prod'::text as src
  , p.lot_id
  , p.slot_seq::text as module_name
  , null::text as module_name
  , null::text as info_name
  , null::timestamp as process_start_tmstp
  , null::timestamp as process_end_tmstp
  , null::int as "order"
  , p.wafer_seq
  , p.exp_start_tmstp
  , p.exp_finish_tmstp
from prod_filtered p
order by
    src
  , lot_id
  , slot_seq;