// week-utils.js
// 일요일 시작 + 전년도 포함 주차 유틸
// 규칙: 해당 연도의 1월 1일이 포함된 주의 일요일이 week1 시작일

import dayjs from 'dayjs'

/**
 * year의 week1 시작 일요일을 반환한다.
 * 규칙: 해당 연도의 1월 1일이 포함된 주의 일요일
 */
function getWeek1Sunday(year) {
  const januaryFirst = dayjs(`${year}-01-01`, 'YYYY-MM-DD')
  const weekday = januaryFirst.day()  // 0=Sun ~ 6=Sat
  return januaryFirst.subtract(weekday, 'day')
}

/**
 * 오늘 날짜가 해당 연도에서 몇 번째 Sunday-based week인지 반환한다.
 * (내부 전용 헬퍼)
 */
function getCurrentSundayBasedWeek(year) {
  const today = dayjs()
  const targetYear = year || today.year()

  const week1Sunday = getWeek1Sunday(targetYear)
  const daysSinceWeek1 = today.diff(week1Sunday, 'day')

  return Math.floor(daysSinceWeek1 / 7) + 1
}

export default {
  /**
   * 오늘까지의 Sunday-based week 배열을 반환한다.
   * 예: ['w1', 'w2', ..., 'w45']
   *
   * @param {number} year 기준 연도 (생략 시 today.year())
   * @returns {string[]} ['w1', 'w2', ...]
   */
  getSundayBasedWeeksUntilToday(year) {
    const currentYear = year || dayjs().year()
    const currentWeek = getCurrentSundayBasedWeek(currentYear)

    return Array.from(
      { length: currentWeek },
      (_, index) => `w${index + 1}`
    )
  },

  /**
   * 날짜 범위(시작일 ~ 종료일)에 포함되는 Sunday-based week 배열을 반환한다.
   * 예: ['w3', 'w4', 'w5']
   *
   * @param {number} year 기준 연도
   * @param {string} startDateStr 'YYYY-MM-DD'
   * @param {string} endDateStr   'YYYY-MM-DD'
   * @returns {string[]} ['wN', ...]
   */
  getSundayBasedWeeksInDateRange(year, startDateStr, endDateStr) {
    const startDate = dayjs(startDateStr, 'YYYY-MM-DD')
    const endDate = dayjs(endDateStr, 'YYYY-MM-DD')

    const week1Sunday = getWeek1Sunday(year)
    const matchedWeeks = []
    const maxWeeks = 60

    for (let index = 0; index < maxWeeks; index += 1) {
      const weekStart = week1Sunday.add(index * 7, 'day')
      const weekEnd = weekStart.add(6, 'day')

      const overlaps =
        weekEnd.isSameOrAfter(startDate, 'day') &&
        weekStart.isSameOrBefore(endDate, 'day')

      if (overlaps) {
        matchedWeeks.push(`w${index + 1}`)
      }
    }

    return matchedWeeks
  },

  /**
   * 주차 또는 주차 배열에 해당하는 전체 날짜 범위를 반환한다.
   * 예: { startDate: 'YYYY-MM-DD', endDate: 'YYYY-MM-DD' }
   *
   * @param {number} year 기준 연도
   * @param {string|string[]} weekInputs 'w3' 또는 ['w3', 'w4', ...]
   * @returns {{ startDate: string, endDate: string } | null}
   */
  getSundayBasedDateRangeForWeeks(year, weekInputs) {
    if (!weekInputs) {
      return null
    }

    const weekList = Array.isArray(weekInputs) ? weekInputs : [weekInputs]
    const week1Sunday = getWeek1Sunday(year)

    let minStart = null
    let maxEnd = null

    weekList.forEach((weekString) => {
      const weekNumber = parseInt(String(weekString).toLowerCase().replace('w', ''), 10)
      if (!weekNumber || weekNumber <= 0) {
        return
      }

      const weekStart = week1Sunday.add((weekNumber - 1) * 7, 'day')
      const weekEnd = weekStart.add(6, 'day')

      if (!minStart || weekStart.isBefore(minStart)) {
        minStart = weekStart
      }
      if (!maxEnd || weekEnd.isAfter(maxEnd)) {
        maxEnd = weekEnd
      }
    })

    if (!minStart || !maxEnd) {
      return null
    }

    return {
      startDate: minStart.format('YYYY-MM-DD'),
      endDate: maxEnd.format('YYYY-MM-DD')
    }
  }
}